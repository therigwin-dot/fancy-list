"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.loadScriptWithoutEval = void 0;
var tslib_1 = require("tslib");
var sp_core_library_1 = require("@microsoft/sp-core-library");
var isCorsEnabled_1 = tslib_1.__importDefault(require("../utilities/isCorsEnabled"));
/**
 * Start download the script without evaluating it.
 * For chromium based browsers, Edge, Safari and Firefox use <link rel='preload'>.
 * For IE, use <script type= 'text/cache'>. Wrong type will let IE avoid evaluating.
 * For other browser, won't affect.
 *
 * Tested in Chrome, Edge Chromium, Edge, Safari, IE, Firefox.
 */
function loadScriptWithoutEval(address, appendJSExtension, isSpfxSubResourceIntegrityFlightEnabled // defaulting to false for systemJSLoader case
) {
    if (appendJSExtension === void 0) { appendJSExtension = true; }
    if (isSpfxSubResourceIntegrityFlightEnabled === void 0) { isSpfxSubResourceIntegrityFlightEnabled = false; }
    var scriptUrl = address.path;
    if (!document) {
        return Promise.resolve();
    }
    if (appendJSExtension) {
        scriptUrl = "".concat(scriptUrl, ".js");
    }
    return new Promise(function (resolve, reject) {
        var browser = sp_core_library_1._BrowserDetection.getBrowserInformation().browser;
        var isCrossOrigin = (0, isCorsEnabled_1.default)(scriptUrl, isSpfxSubResourceIntegrityFlightEnabled);
        var isIntegrityEnabled = !!address.integrity && isSpfxSubResourceIntegrityFlightEnabled;
        switch (browser) {
            case sp_core_library_1._Browser.Chrome:
            case sp_core_library_1._Browser.EdgeChromium:
            case sp_core_library_1._Browser.Edge:
            case sp_core_library_1._Browser.Safari:
            case sp_core_library_1._Browser.Firefox: {
                var link = document.createElement('link');
                link.as = 'script';
                link.rel = 'preload';
                if (isCrossOrigin || isIntegrityEnabled) {
                    link.crossOrigin = 'anonymous';
                }
                link.href = scriptUrl;
                if (isIntegrityEnabled) {
                    link.integrity = address.integrity;
                }
                link.onload = function () { return resolve(); };
                link.onerror = function (e) { return reject(e); };
                document.head.appendChild(link);
                break;
            }
            case sp_core_library_1._Browser.IE: {
                var script = document.createElement('script');
                // IE will not evaluate the script.
                script.type = 'text/cache';
                script.src = scriptUrl;
                if (isCrossOrigin || isIntegrityEnabled) {
                    script.crossOrigin = 'anonymous';
                }
                if (isIntegrityEnabled) {
                    script.integrity = address.integrity;
                }
                document.head.appendChild(script);
                break;
            }
            default: {
                resolve();
            }
        }
    });
}
exports.loadScriptWithoutEval = loadScriptWithoutEval;
//# sourceMappingURL=loadScriptWithoutEval.js.map