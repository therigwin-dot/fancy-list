{"version":3,"file":"BaseLinkManager.js","sourceRoot":"","sources":["../../../src/logic/base/BaseLinkManager.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\n// See LICENSE in the project root for license information.\n\nimport * as path from 'path';\n\nimport {\n  FileSystem,\n  type FileSystemStats,\n  type IFileSystemCreateLinkOptions,\n  InternalError\n} from '@rushstack/node-core-library';\nimport { Colorize } from '@rushstack/terminal';\n\nimport type { RushConfiguration } from '../../api/RushConfiguration';\nimport { Utilities } from '../../utilities/Utilities';\nimport { Stopwatch } from '../../utilities/Stopwatch';\nimport type { BasePackage } from './BasePackage';\nimport { EnvironmentConfiguration } from '../../api/EnvironmentConfiguration';\nimport { RushConstants } from '../RushConstants';\nimport { FlagFile } from '../../api/FlagFile';\n\nexport enum SymlinkKind {\n  File,\n  Directory\n}\n\nexport interface IBaseLinkManagerCreateSymlinkOptions extends IFileSystemCreateLinkOptions {\n  symlinkKind: SymlinkKind;\n}\n\nexport abstract class BaseLinkManager {\n  protected _rushConfiguration: RushConfiguration;\n\n  public constructor(rushConfiguration: RushConfiguration) {\n    this._rushConfiguration = rushConfiguration;\n  }\n\n  public static _createSymlink(options: IBaseLinkManagerCreateSymlinkOptions): void {\n    const newLinkFolder: string = path.dirname(options.newLinkPath);\n    FileSystem.ensureFolder(newLinkFolder);\n\n    let targetPath: string;\n    if (EnvironmentConfiguration.absoluteSymlinks) {\n      targetPath = options.linkTargetPath;\n    } else {\n      // Link to the relative path, to avoid going outside containers such as a Docker image\n      targetPath = path.relative(FileSystem.getRealPath(newLinkFolder), options.linkTargetPath);\n    }\n\n    if (process.platform === 'win32') {\n      if (options.symlinkKind === SymlinkKind.Directory) {\n        // For directories, we use a Windows \"junction\".  On Unix, this produces a regular symlink.\n        FileSystem.createSymbolicLinkJunction({\n          linkTargetPath: targetPath,\n          newLinkPath: options.newLinkPath\n        });\n      } else {\n        // For files, we use a Windows \"hard link\", because creating a symbolic link requires\n        // administrator permission.\n\n        // NOTE: We cannot use the relative path for hard links\n        FileSystem.createHardLink({\n          linkTargetPath: options.linkTargetPath,\n          newLinkPath: options.newLinkPath\n        });\n      }\n    } else {\n      // However hard links seem to cause build failures on Mac, so for all other operating systems\n      // we use symbolic links for this case.\n      if (options.symlinkKind === SymlinkKind.Directory) {\n        FileSystem.createSymbolicLinkFolder({\n          linkTargetPath: targetPath,\n          newLinkPath: options.newLinkPath\n        });\n      } else {\n        FileSystem.createSymbolicLinkFile({\n          linkTargetPath: targetPath,\n          newLinkPath: options.newLinkPath\n        });\n      }\n    }\n  }\n\n  /**\n   * For a Package object that represents a top-level Rush project folder\n   * (i.e. with source code that we will be building), this clears out its\n   * node_modules folder and then recursively creates all the symlinked folders.\n   */\n  protected static _createSymlinksForTopLevelProject(localPackage: BasePackage): void {\n    const localModuleFolder: string = path.join(localPackage.folderPath, 'node_modules');\n\n    // Sanity check\n    if (localPackage.parent) {\n      throw new Error('The provided package is not a top-level project');\n    }\n\n    // The root-level folder is the project itself, so we simply delete its node_modules\n    // to start clean\n    // eslint-disable-next-line no-console\n    console.log('Purging ' + localModuleFolder);\n    Utilities.dangerouslyDeletePath(localModuleFolder);\n\n    if (localPackage.children.length > 0) {\n      Utilities.createFolderWithRetry(localModuleFolder);\n\n      for (const child of localPackage.children) {\n        BaseLinkManager._createSymlinksForDependencies(child);\n      }\n    }\n  }\n\n  /**\n   * This is a helper function used by createSymlinksForTopLevelProject().\n   * It will recursively creates symlinked folders corresponding to each of the\n   * Package objects in the provided tree.\n   */\n  private static _createSymlinksForDependencies(localPackage: BasePackage): void {\n    const localModuleFolder: string = path.join(localPackage.folderPath, 'node_modules');\n\n    if (!localPackage.symlinkTargetFolderPath) {\n      throw new InternalError('localPackage.symlinkTargetFolderPath was not assigned');\n    }\n\n    // This is special case for when localPackage.name has the form '@scope/name',\n    // in which case we need to create the '@scope' folder first.\n    const parentFolderPath: string = path.dirname(localPackage.folderPath);\n    if (parentFolderPath && parentFolderPath !== localPackage.folderPath) {\n      if (!FileSystem.exists(parentFolderPath)) {\n        Utilities.createFolderWithRetry(parentFolderPath);\n      }\n    }\n\n    if (localPackage.children.length === 0) {\n      // If there are no children, then we can symlink the entire folder\n      BaseLinkManager._createSymlink({\n        linkTargetPath: localPackage.symlinkTargetFolderPath,\n        newLinkPath: localPackage.folderPath,\n        symlinkKind: SymlinkKind.Directory\n      });\n    } else {\n      // If there are children, then we need to symlink each item in the folder individually\n      Utilities.createFolderWithRetry(localPackage.folderPath);\n\n      for (const filename of FileSystem.readFolderItemNames(localPackage.symlinkTargetFolderPath)) {\n        if (filename.toLowerCase() !== 'node_modules') {\n          // Create the symlink\n          let symlinkKind: SymlinkKind = SymlinkKind.File;\n\n          const linkSource: string = path.join(localPackage.folderPath, filename);\n          let linkTarget: string = path.join(localPackage.symlinkTargetFolderPath, filename);\n\n          const linkStats: FileSystemStats = FileSystem.getLinkStatistics(linkTarget);\n\n          if (linkStats.isSymbolicLink()) {\n            const targetStats: FileSystemStats = FileSystem.getStatistics(FileSystem.getRealPath(linkTarget));\n            if (targetStats.isDirectory()) {\n              // Neither a junction nor a directory-symlink can have a directory-symlink\n              // as its target; instead, we must obtain the real physical path.\n              // A junction can link to another junction.  Unfortunately, the node 'fs' API\n              // lacks the ability to distinguish between a junction and a directory-symlink\n              // (even though it has the ability to create them both), so the safest policy\n              // is to always make a junction and always to the real physical path.\n              linkTarget = FileSystem.getRealPath(linkTarget);\n              symlinkKind = SymlinkKind.Directory;\n            }\n          } else if (linkStats.isDirectory()) {\n            symlinkKind = SymlinkKind.Directory;\n          }\n\n          BaseLinkManager._createSymlink({\n            linkTargetPath: linkTarget,\n            newLinkPath: linkSource,\n            symlinkKind\n          });\n        }\n      }\n    }\n\n    if (localPackage.children.length > 0) {\n      Utilities.createFolderWithRetry(localModuleFolder);\n\n      for (const child of localPackage.children) {\n        BaseLinkManager._createSymlinksForDependencies(child);\n      }\n    }\n  }\n\n  /**\n   * Creates node_modules symlinks for all Rush projects defined in the RushConfiguration.\n   * @param force - Normally the operation will be skipped if the links are already up to date;\n   *   if true, this option forces the links to be recreated.\n   */\n  public async createSymlinksForProjectsAsync(force: boolean): Promise<void> {\n    // eslint-disable-next-line no-console\n    console.log('\\n' + Colorize.bold('Linking local projects'));\n    const stopwatch: Stopwatch = Stopwatch.start();\n\n    await this._linkProjectsAsync();\n\n    // TODO: Remove when \"rush link\" and \"rush unlink\" are deprecated\n    await new FlagFile(\n      this._rushConfiguration.defaultSubspace.getSubspaceTempFolderPath(),\n      RushConstants.lastLinkFlagFilename,\n      {}\n    ).createAsync();\n\n    stopwatch.stop();\n    // eslint-disable-next-line no-console\n    console.log('\\n' + Colorize.green(`Linking finished successfully. (${stopwatch.toString()})`));\n    // eslint-disable-next-line no-console\n    console.log('\\nNext you should probably run \"rush build\" or \"rush rebuild\"');\n  }\n\n  protected abstract _linkProjectsAsync(): Promise<void>;\n}\n"]}