{"version":3,"file":"AddAction.js","sourceRoot":"","sources":["../../../src/cli/actions/AddAction.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\n// See LICENSE in the project root for license information.\n\nimport * as semver from 'semver';\nimport type {\n  CommandLineFlagParameter,\n  CommandLineStringListParameter,\n  CommandLineStringParameter\n} from '@rushstack/ts-command-line';\n\nimport { BaseAddAndRemoveAction } from './BaseAddAndRemoveAction';\nimport type { RushCommandLineParser } from '../RushCommandLineParser';\nimport { DependencySpecifier } from '../../logic/DependencySpecifier';\nimport type { RushConfigurationProject } from '../../api/RushConfigurationProject';\nimport {\n  type IPackageForRushAdd,\n  type IPackageJsonUpdaterRushAddOptions,\n  SemVerStyle\n} from '../../logic/PackageJsonUpdaterTypes';\nimport { getVariantAsync, VARIANT_PARAMETER } from '../../api/Variants';\n\nexport class AddAction extends BaseAddAndRemoveAction {\n  protected readonly _allFlag: CommandLineFlagParameter;\n  protected readonly _packageNameList: CommandLineStringListParameter;\n  private readonly _exactFlag: CommandLineFlagParameter;\n  private readonly _caretFlag: CommandLineFlagParameter;\n  private readonly _devDependencyFlag: CommandLineFlagParameter;\n  private readonly _peerDependencyFlag: CommandLineFlagParameter;\n  private readonly _makeConsistentFlag: CommandLineFlagParameter;\n  private readonly _variantParameter: CommandLineStringParameter;\n\n  public constructor(parser: RushCommandLineParser) {\n    const documentation: string = [\n      'Adds specified package(s) to the dependencies of the current project (as determined by the current working directory)' +\n        ' and then runs \"rush update\". If no version is specified, a version will be automatically detected (typically' +\n        ' either the latest version or a version that won\\'t break the \"ensureConsistentVersions\" policy). If a version' +\n        ' range (or a workspace range) is specified, the latest version in the range will be used. The version will be' +\n        ' automatically prepended with a tilde, unless the \"--exact\" or \"--caret\" flags are used. The \"--make-consistent\"' +\n        ' flag can be used to update all packages with the dependency.'\n    ].join('\\n');\n    super({\n      actionName: 'add',\n      summary: 'Adds one or more dependencies to the package.json and runs rush update.',\n      documentation,\n      safeForSimultaneousRushProcesses: false,\n      parser\n    });\n\n    this._packageNameList = this.defineStringListParameter({\n      parameterLongName: '--package',\n      parameterShortName: '-p',\n      required: true,\n      argumentName: 'PACKAGE',\n      description:\n        'The name of the package which should be added as a dependency.' +\n        ' A SemVer version specifier can be appended after an \"@\" sign.  WARNING: Symbol characters' +\n        \" are usually interpreted by your shell, so it's recommended to use quotes.\" +\n        ' For example, write \"rush add --package \"example@^1.2.3\"\" instead of \"rush add --package example@^1.2.3\".' +\n        ' To add multiple packages, write \"rush add --package foo --package bar\".'\n    });\n    this._exactFlag = this.defineFlagParameter({\n      parameterLongName: '--exact',\n      description:\n        'If specified, the SemVer specifier added to the' +\n        ' package.json will be an exact version (e.g. without tilde or caret).'\n    });\n    this._caretFlag = this.defineFlagParameter({\n      parameterLongName: '--caret',\n      description:\n        'If specified, the SemVer specifier added to the' +\n        ' package.json will be a prepended with a \"caret\" specifier (\"^\").'\n    });\n    this._devDependencyFlag = this.defineFlagParameter({\n      parameterLongName: '--dev',\n      description:\n        'If specified, the package will be added to the \"devDependencies\" section of the package.json'\n    });\n    this._peerDependencyFlag = this.defineFlagParameter({\n      parameterLongName: '--peer',\n      description:\n        'If specified, the package will be added to the \"peerDependencies\" section of the package.json'\n    });\n    this._makeConsistentFlag = this.defineFlagParameter({\n      parameterLongName: '--make-consistent',\n      parameterShortName: '-m',\n      description:\n        'If specified, other packages with this dependency will have their package.json' +\n        ' files updated to use the same version of the dependency.'\n    });\n    this._allFlag = this.defineFlagParameter({\n      parameterLongName: '--all',\n      description: 'If specified, the dependency will be added to all projects.'\n    });\n    this._variantParameter = this.defineStringParameter(VARIANT_PARAMETER);\n  }\n\n  public async getUpdateOptionsAsync(): Promise<IPackageJsonUpdaterRushAddOptions> {\n    const projects: RushConfigurationProject[] = super.getProjects();\n\n    if (this._caretFlag.value && this._exactFlag.value) {\n      throw new Error(\n        `Only one of \"${this._caretFlag.longName}\" and \"${this._exactFlag.longName}\" should be specified`\n      );\n    }\n\n    const packagesToAdd: IPackageForRushAdd[] = [];\n\n    for (const specifiedPackageName of this.specifiedPackageNameList) {\n      /**\n       * Name & Version\n       */\n      let packageName: string = specifiedPackageName;\n      let version: string | undefined = undefined;\n      const parts: string[] = packageName.split('@');\n\n      if (parts[0] === '') {\n        // this is a scoped package\n        packageName = '@' + parts[1];\n        version = parts[2];\n      } else {\n        packageName = parts[0];\n        version = parts[1];\n      }\n\n      if (!this.rushConfiguration.packageNameParser.isValidName(packageName)) {\n        throw new Error(`The package name \"${packageName}\" is not valid.`);\n      }\n\n      if (version && version !== 'latest') {\n        const specifier: DependencySpecifier = new DependencySpecifier(packageName, version);\n        if (!semver.validRange(specifier.versionSpecifier) && !semver.valid(specifier.versionSpecifier)) {\n          throw new Error(`The SemVer specifier \"${version}\" is not valid.`);\n        }\n      }\n\n      /**\n       * RangeStyle\n       */\n      let rangeStyle: SemVerStyle;\n      if (version && version !== 'latest') {\n        if (this._exactFlag.value || this._caretFlag.value) {\n          throw new Error(\n            `The \"${this._caretFlag.longName}\" and \"${this._exactFlag.longName}\" flags may not be specified if a ` +\n              `version is provided in the ${this._packageNameList.longName} specifier. In this case \"${version}\" was provided.`\n          );\n        }\n\n        rangeStyle = SemVerStyle.Passthrough;\n      } else {\n        rangeStyle = this._caretFlag.value\n          ? SemVerStyle.Caret\n          : this._exactFlag.value\n            ? SemVerStyle.Exact\n            : SemVerStyle.Tilde;\n      }\n\n      packagesToAdd.push({ packageName, version, rangeStyle });\n    }\n\n    const variant: string | undefined = await getVariantAsync(\n      this._variantParameter,\n      this.rushConfiguration,\n      true\n    );\n\n    return {\n      projects: projects,\n      packagesToUpdate: packagesToAdd,\n      devDependency: this._devDependencyFlag.value,\n      peerDependency: this._peerDependencyFlag.value,\n      updateOtherPackages: this._makeConsistentFlag.value,\n      skipUpdate: this._skipUpdateFlag.value,\n      debugInstall: this.parser.isDebug,\n      actionName: this.actionName,\n      variant\n    };\n  }\n}\n"]}