{"version":3,"file":"UpdateCloudCredentialsAction.js","sourceRoot":"","sources":["../../../src/cli/actions/UpdateCloudCredentialsAction.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\n// See LICENSE in the project root for license information.\n\nimport type { CommandLineStringParameter, CommandLineFlagParameter } from '@rushstack/ts-command-line';\nimport { AlreadyReportedError } from '@rushstack/node-core-library';\nimport { ConsoleTerminalProvider, Terminal } from '@rushstack/terminal';\n\nimport type { RushCommandLineParser } from '../RushCommandLineParser';\nimport { BaseRushAction } from './BaseRushAction';\nimport { BuildCacheConfiguration } from '../../api/BuildCacheConfiguration';\nimport { RushConstants } from '../../logic/RushConstants';\n\nexport class UpdateCloudCredentialsAction extends BaseRushAction {\n  private readonly _interactiveModeFlag: CommandLineFlagParameter;\n  private readonly _credentialParameter: CommandLineStringParameter;\n  private readonly _deleteFlag: CommandLineFlagParameter;\n\n  public constructor(parser: RushCommandLineParser) {\n    super({\n      actionName: RushConstants.updateCloudCredentialsCommandName,\n      summary: '(EXPERIMENTAL) Update the credentials used by the build cache provider.',\n      documentation:\n        '(EXPERIMENTAL) If the build caching feature is configured, this command facilitates ' +\n        'updating the credentials used by a cloud-based provider.',\n      safeForSimultaneousRushProcesses: false,\n      parser\n    });\n\n    this._interactiveModeFlag = this.defineFlagParameter({\n      parameterLongName: '--interactive',\n      parameterShortName: '-i',\n      description: 'Run the credential update operation in interactive mode, if supported by the provider.'\n    });\n    this._credentialParameter = this.defineStringParameter({\n      parameterLongName: '--credential',\n      argumentName: 'CREDENTIAL_STRING',\n      description: 'A static credential, to be cached.'\n    });\n    this._deleteFlag = this.defineFlagParameter({\n      parameterLongName: '--delete',\n      parameterShortName: '-d',\n      description: 'If specified, delete stored credentials.'\n    });\n  }\n\n  protected async runAsync(): Promise<void> {\n    const terminal: Terminal = new Terminal(new ConsoleTerminalProvider());\n\n    const buildCacheConfiguration: BuildCacheConfiguration =\n      await BuildCacheConfiguration.loadAndRequireEnabledAsync(\n        terminal,\n        this.rushConfiguration,\n        this.rushSession\n      );\n\n    if (this._deleteFlag.value) {\n      if (this._interactiveModeFlag.value || this._credentialParameter.value !== undefined) {\n        terminal.writeErrorLine(\n          `If the ${this._deleteFlag.longName} is provided, no other parameters may be provided.`\n        );\n        throw new AlreadyReportedError();\n      } else if (buildCacheConfiguration.cloudCacheProvider) {\n        await buildCacheConfiguration.cloudCacheProvider.deleteCachedCredentialsAsync(terminal);\n      } else {\n        terminal.writeLine('A cloud build cache is not configured; there is nothing to delete.');\n      }\n    } else if (this._interactiveModeFlag.value && this._credentialParameter.value !== undefined) {\n      terminal.writeErrorLine(\n        `Both the ${this._interactiveModeFlag.longName} and the ` +\n          `${this._credentialParameter.longName} parameters were provided. Only one ` +\n          'or the other may be used at a time.'\n      );\n      throw new AlreadyReportedError();\n    } else if (this._interactiveModeFlag.value) {\n      if (buildCacheConfiguration.cloudCacheProvider) {\n        await buildCacheConfiguration.cloudCacheProvider.updateCachedCredentialInteractiveAsync(terminal);\n      } else {\n        terminal.writeLine('A cloud build cache is not configured. Credentials are not required.');\n      }\n    } else if (this._credentialParameter.value !== undefined) {\n      if (buildCacheConfiguration.cloudCacheProvider) {\n        await buildCacheConfiguration.cloudCacheProvider.updateCachedCredentialAsync(\n          terminal,\n          this._credentialParameter.value\n        );\n      } else {\n        terminal.writeErrorLine('A cloud build cache is not configured. Credentials are not supported.');\n        throw new AlreadyReportedError();\n      }\n    } else {\n      terminal.writeErrorLine(\n        `One of the ${this._interactiveModeFlag.longName} parameter, the ` +\n          `${this._credentialParameter.longName} parameter, or the ` +\n          `${this._deleteFlag.longName} parameter must be provided.`\n      );\n      throw new AlreadyReportedError();\n    }\n  }\n}\n"]}