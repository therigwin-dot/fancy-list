{"version":3,"file":"ScanAction.js","sourceRoot":"","sources":["../../../src/cli/actions/ScanAction.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\n// See LICENSE in the project root for license information.\n\nimport * as path from 'path';\nimport builtinPackageNames from 'builtin-modules';\nimport { Colorize } from '@rushstack/terminal';\nimport type { CommandLineFlagParameter } from '@rushstack/ts-command-line';\nimport { FileSystem } from '@rushstack/node-core-library';\n\nimport type { RushCommandLineParser } from '../RushCommandLineParser';\nimport { BaseConfiglessRushAction } from './BaseRushAction';\n\nexport interface IJsonOutput {\n  /**\n   * Dependencies scan from source code\n   */\n  detectedDependencies: string[];\n  /**\n   * Dependencies detected but not declared in package.json\n   */\n  missingDependencies: string[];\n  /**\n   * Dependencies declared in package.json, but not used in source code\n   */\n  unusedDependencies: string[];\n}\n\nexport class ScanAction extends BaseConfiglessRushAction {\n  private readonly _jsonFlag: CommandLineFlagParameter;\n  private readonly _allFlag: CommandLineFlagParameter;\n\n  public constructor(parser: RushCommandLineParser) {\n    super({\n      actionName: 'scan',\n      summary:\n        'When migrating projects into a Rush repo, this command is helpful for detecting' +\n        ' undeclared dependencies.',\n      documentation:\n        `The Node.js module system allows a project to import NPM packages without explicitly` +\n        ` declaring them as dependencies in the package.json file.  Such \"phantom dependencies\"` +\n        ` can cause problems.  Rush and PNPM use symlinks specifically to protect against phantom dependencies.` +\n        ` These protections may cause runtime errors for existing projects when they are first migrated into` +\n        ` a Rush monorepo.  The \"rush scan\" command is a handy tool for fixing these errors. It scans the \"./src\"` +\n        ` and \"./lib\" folders for import syntaxes such as \"import __ from '__'\", \"require('__')\",` +\n        ` and \"System.import('__').  It prints a report of the referenced packages.  This heuristic is` +\n        ` not perfect, but it can save a lot of time when migrating projects.`,\n      safeForSimultaneousRushProcesses: true,\n      parser\n    });\n\n    this._jsonFlag = this.defineFlagParameter({\n      parameterLongName: '--json',\n      description: 'If this flag is specified, output will be in JSON format.'\n    });\n    this._allFlag = this.defineFlagParameter({\n      parameterLongName: '--all',\n      description: 'If this flag is specified, output will list all detected dependencies.'\n    });\n  }\n\n  protected async runAsync(): Promise<void> {\n    const packageJsonFilename: string = path.resolve('./package.json');\n\n    if (!FileSystem.exists(packageJsonFilename)) {\n      throw new Error('You must run \"rush scan\" in a project folder containing a package.json file.');\n    }\n\n    const requireRegExps: RegExp[] = [\n      // Example: require('something')\n      /\\brequire\\s*\\(\\s*[']([^']+\\s*)[']\\s*\\)/,\n      /\\brequire\\s*\\(\\s*[\"]([^\"]+\\s*)[\"]\\s*\\)/,\n\n      // Example: require.ensure('something')\n      /\\brequire\\.ensure\\s*\\(\\s*[']([^']+\\s*)[']\\s*\\)/,\n      /\\brequire\\.ensure\\s*\\(\\s*[\"]([^\"]+\\s*)[\"]\\s*\\)/,\n\n      // Example: require.resolve('something')\n      /\\brequire\\.resolve\\s*\\(\\s*[']([^']+\\s*)[']\\s*\\)/,\n      /\\brequire\\.resolve\\s*\\(\\s*[\"]([^\"]+\\s*)[\"]\\s*\\)/,\n\n      // Example: System.import('something')\n      /\\bSystem\\.import\\s*\\(\\s*[']([^']+\\s*)[']\\s*\\)/,\n      /\\bSystem\\.import\\s*\\(\\s*[\"]([^\"]+\\s*)[\"]\\s*\\)/,\n\n      // Example: Import.lazy('something', require);\n      /\\bImport\\.lazy\\s*\\(\\s*[']([^']+\\s*)[']/,\n      /\\bImport\\.lazy\\s*\\(\\s*[\"]([^\"]+\\s*)[\"]/,\n\n      // Example:\n      //\n      // import {\n      //   A, B\n      // } from 'something';\n      /\\bfrom\\s*[']([^']+)[']/,\n      /\\bfrom\\s*[\"]([^\"]+)[\"]/,\n\n      // Example:  import 'something';\n      /\\bimport\\s*[']([^']+)[']\\s*\\;/,\n      /\\bimport\\s*[\"]([^\"]+)[\"]\\s*\\;/,\n\n      // Example: await import('fast-glob')\n      /\\bimport\\s*\\(\\s*[']([^']+)[']\\s*\\)/,\n      /\\bimport\\s*\\(\\s*[\"]([^\"]+)[\"]\\s*\\)/,\n\n      // Example:\n      // /// <reference types=\"something\" />\n      /\\/\\/\\/\\s*<\\s*reference\\s+types\\s*=\\s*[\"]([^\"]+)[\"]\\s*\\/>/\n    ];\n\n    // Example: \"my-package/lad/dee/dah\" --> \"my-package\"\n    // Example: \"@ms/my-package\" --> \"@ms/my-package\"\n    // Example: \"lodash.get\" --> \"lodash.get\"\n    const packageRegExp: RegExp = /^((@[a-z\\-0-9!_]+\\/)?[a-z\\-0-9!_][a-z\\-0-9!_.]*)\\/?/;\n\n    const requireMatches: Set<string> = new Set<string>();\n\n    const { default: glob } = await import('fast-glob');\n    const scanResults: string[] = await glob(['./*.{ts,js,tsx,jsx}', './{src,lib}/**/*.{ts,js,tsx,jsx}']);\n    for (const filename of scanResults) {\n      try {\n        const contents: string = FileSystem.readFile(filename);\n        const lines: string[] = contents.split('\\n');\n\n        for (const line of lines) {\n          for (const requireRegExp of requireRegExps) {\n            const requireRegExpResult: RegExpExecArray | null = requireRegExp.exec(line);\n            if (requireRegExpResult) {\n              requireMatches.add(requireRegExpResult[1]);\n            }\n          }\n        }\n      } catch (error) {\n        // eslint-disable-next-line no-console\n        console.log(Colorize.bold('Skipping file due to error: ' + filename));\n      }\n    }\n\n    const packageMatches: Set<string> = new Set<string>();\n\n    requireMatches.forEach((requireMatch: string) => {\n      const packageRegExpResult: RegExpExecArray | null = packageRegExp.exec(requireMatch);\n      if (packageRegExpResult) {\n        packageMatches.add(packageRegExpResult[1]);\n      }\n    });\n\n    const detectedPackageNames: string[] = [];\n\n    packageMatches.forEach((packageName: string) => {\n      if (builtinPackageNames.indexOf(packageName) < 0) {\n        detectedPackageNames.push(packageName);\n      }\n    });\n\n    detectedPackageNames.sort();\n\n    const declaredDependencies: Set<string> = new Set<string>();\n    const declaredDevDependencies: Set<string> = new Set<string>();\n    const missingDependencies: string[] = [];\n    const unusedDependencies: string[] = [];\n    const packageJsonContent: string = FileSystem.readFile(packageJsonFilename);\n    try {\n      const manifest: {\n        dependencies?: Record<string, string>;\n        devDependencies?: Record<string, string>;\n      } = JSON.parse(packageJsonContent);\n      if (manifest.dependencies) {\n        for (const depName of Object.keys(manifest.dependencies)) {\n          declaredDependencies.add(depName);\n        }\n      }\n      if (manifest.devDependencies) {\n        for (const depName of Object.keys(manifest.devDependencies)) {\n          declaredDevDependencies.add(depName);\n        }\n      }\n    } catch (e) {\n      // eslint-disable-next-line no-console\n      console.error(`JSON.parse ${packageJsonFilename} error`);\n    }\n\n    for (const detectedPkgName of detectedPackageNames) {\n      /**\n       * Missing(phantom) dependencies are\n       * - used in source code\n       * - not decalred in dependencies and devDependencies in package.json\n       */\n      if (!declaredDependencies.has(detectedPkgName) && !declaredDevDependencies.has(detectedPkgName)) {\n        missingDependencies.push(detectedPkgName);\n      }\n    }\n    for (const declaredPkgName of declaredDependencies) {\n      /**\n       * Unused dependencies are\n       * - declared in dependencies in package.json (devDependencies not included)\n       * - not used in source code\n       */\n      if (!detectedPackageNames.includes(declaredPkgName) && !declaredPkgName.startsWith('@types/')) {\n        unusedDependencies.push(declaredPkgName);\n      }\n    }\n\n    const output: IJsonOutput = {\n      detectedDependencies: detectedPackageNames,\n      missingDependencies: missingDependencies,\n      unusedDependencies: unusedDependencies\n    };\n\n    if (this._jsonFlag.value) {\n      // eslint-disable-next-line no-console\n      console.log(JSON.stringify(output, undefined, 2));\n    } else if (this._allFlag.value) {\n      if (detectedPackageNames.length !== 0) {\n        // eslint-disable-next-line no-console\n        console.log('Dependencies that seem to be imported by this project:');\n        for (const packageName of detectedPackageNames) {\n          // eslint-disable-next-line no-console\n          console.log('  ' + packageName);\n        }\n      } else {\n        // eslint-disable-next-line no-console\n        console.log('This project does not seem to import any NPM packages.');\n      }\n    } else {\n      let wroteAnything: boolean = false;\n\n      if (missingDependencies.length > 0) {\n        // eslint-disable-next-line no-console\n        console.log(\n          Colorize.yellow('Possible phantom dependencies') +\n            \" - these seem to be imported but aren't listed in package.json:\"\n        );\n        for (const packageName of missingDependencies) {\n          // eslint-disable-next-line no-console\n          console.log('  ' + packageName);\n        }\n        wroteAnything = true;\n      }\n\n      if (unusedDependencies.length > 0) {\n        if (wroteAnything) {\n          // eslint-disable-next-line no-console\n          console.log('');\n        }\n        // eslint-disable-next-line no-console\n        console.log(\n          Colorize.yellow('Possible unused dependencies') +\n            \" - these are listed in package.json but don't seem to be imported:\"\n        );\n        for (const packageName of unusedDependencies) {\n          // eslint-disable-next-line no-console\n          console.log('  ' + packageName);\n        }\n        wroteAnything = true;\n      }\n\n      if (!wroteAnything) {\n        // eslint-disable-next-line no-console\n        console.log(\n          Colorize.green('Everything looks good.') + '  No missing or unused dependencies were found.'\n        );\n      }\n    }\n  }\n}\n"]}