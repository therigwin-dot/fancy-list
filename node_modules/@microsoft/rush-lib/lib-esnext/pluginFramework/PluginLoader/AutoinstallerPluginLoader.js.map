{"version":3,"file":"AutoinstallerPluginLoader.js","sourceRoot":"","sources":["../../../src/pluginFramework/PluginLoader/AutoinstallerPluginLoader.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\n// See LICENSE in the project root for license information.\n\nimport * as path from 'path';\nimport {\n  FileSystem,\n  JsonFile,\n  PosixModeBits,\n  type JsonObject,\n  type JsonSchema\n} from '@rushstack/node-core-library';\n\nimport type { IRushPluginConfiguration } from '../../api/RushPluginsConfiguration';\nimport { Autoinstaller } from '../../logic/Autoinstaller';\nimport { RushConstants } from '../../logic/RushConstants';\nimport {\n  type IPluginLoaderOptions,\n  type IRushPluginManifest,\n  type IRushPluginManifestJson,\n  PluginLoaderBase\n} from './PluginLoaderBase';\nimport type { RushGlobalFolder } from '../../api/RushGlobalFolder';\n\ninterface IAutoinstallerPluginLoaderOptions extends IPluginLoaderOptions<IRushPluginConfiguration> {\n  restrictConsoleOutput: boolean;\n  rushGlobalFolder: RushGlobalFolder;\n}\n\n/**\n * @beta\n */\nexport class AutoinstallerPluginLoader extends PluginLoaderBase<IRushPluginConfiguration> {\n  public readonly packageFolder: string;\n\n  public readonly autoinstaller: Autoinstaller;\n\n  public constructor(options: IAutoinstallerPluginLoaderOptions) {\n    super(options);\n    this.autoinstaller = new Autoinstaller({\n      autoinstallerName: options.pluginConfiguration.autoinstallerName,\n      rushConfiguration: this._rushConfiguration,\n      restrictConsoleOutput: options.restrictConsoleOutput,\n      rushGlobalFolder: options.rushGlobalFolder\n    });\n\n    this.packageFolder = path.join(this.autoinstaller.folderFullPath, 'node_modules', this.packageName);\n  }\n\n  /**\n   * The folder where rush plugins static files are stored.\n   * Example: `C:\\MyRepo\\common\\autoinstallers\\<autoinstaller_name>\\rush-plugins`\n   */\n  public static getPluginAutoinstallerStorePath(autoinstaller: Autoinstaller): string {\n    return path.join(autoinstaller.folderFullPath, 'rush-plugins');\n  }\n\n  public update(): void {\n    const packageName: string = this.packageName;\n    const pluginName: string = this.pluginName;\n    const packageFolder: string = this.packageFolder;\n    const manifestPath: string = path.join(packageFolder, RushConstants.rushPluginManifestFilename);\n\n    // validate\n    const manifest: IRushPluginManifestJson = JsonFile.loadAndValidate(\n      manifestPath,\n      AutoinstallerPluginLoader._jsonSchema\n    );\n\n    const destinationManifestPath: string = this._getManifestPath();\n    FileSystem.copyFile({\n      sourcePath: manifestPath,\n      destinationPath: destinationManifestPath\n    });\n    // Make permission consistent since it will be committed to Git\n    FileSystem.changePosixModeBits(\n      destinationManifestPath,\n      // eslint-disable-next-line no-bitwise\n      PosixModeBits.AllRead | PosixModeBits.UserWrite\n    );\n\n    const pluginManifest: IRushPluginManifest | undefined = manifest.plugins.find(\n      (item) => item.pluginName === pluginName\n    );\n    if (!pluginManifest) {\n      throw new Error(\n        `A plugin named \"${pluginName}\" is not provided by the Rush plugin package \"${packageName}\"`\n      );\n    }\n\n    const commandLineJsonFilePath: string | undefined = pluginManifest.commandLineJsonFilePath;\n    if (commandLineJsonFilePath) {\n      const commandLineJsonFullFilePath: string = path.join(packageFolder, commandLineJsonFilePath);\n      if (!FileSystem.exists(commandLineJsonFullFilePath)) {\n        this._terminal.writeErrorLine(\n          `The Rush plugin \"${pluginName}\" from \"${packageName}\" specifies a commandLineJsonFilePath` +\n            ` ${commandLineJsonFilePath} that does not exist.`\n        );\n      }\n      const destinationCommandLineJsonFilePath: string = this._getCommandLineJsonFilePath();\n      FileSystem.copyFile({\n        sourcePath: commandLineJsonFullFilePath,\n        destinationPath: destinationCommandLineJsonFilePath\n      });\n      // Make permission consistent since it will be committed to Git\n      FileSystem.changePosixModeBits(\n        destinationCommandLineJsonFilePath,\n        // eslint-disable-next-line no-bitwise\n        PosixModeBits.AllRead | PosixModeBits.UserWrite\n      );\n    }\n  }\n\n  protected override _getCommandLineAdditionalPathFolders(): string[] {\n    const additionalPathFolders: string[] = super._getCommandLineAdditionalPathFolders();\n    additionalPathFolders.push(\n      // Example: `common/autoinstaller/plugins/node_modules/.bin`\n      path.join(this.autoinstaller.folderFullPath, 'node_modules', '.bin')\n    );\n    return additionalPathFolders;\n  }\n\n  protected override _getPluginOptions(): JsonObject {\n    const optionsJsonFilePath: string = this._getPluginOptionsJsonFilePath();\n    const optionsSchema: JsonSchema | undefined = this._getRushPluginOptionsSchema();\n\n    let pluginOptions: JsonObject = {};\n    try {\n      pluginOptions = JsonFile.load(optionsJsonFilePath);\n    } catch (e) {\n      if (FileSystem.isFileDoesNotExistError(e as Error)) {\n        if (optionsSchema) {\n          throw new Error(\n            `Plugin options are required by ${this.pluginName} from package ${this.packageName}, please create it at ${optionsJsonFilePath}.`\n          );\n        } else {\n          return {};\n        }\n      }\n      throw e;\n    }\n\n    if (optionsSchema) {\n      optionsSchema.validateObject(pluginOptions, optionsJsonFilePath);\n    }\n\n    return pluginOptions;\n  }\n\n  protected override _getManifestPath(): string {\n    return path.join(\n      AutoinstallerPluginLoader.getPluginAutoinstallerStorePath(this.autoinstaller),\n      this.packageName,\n      RushConstants.rushPluginManifestFilename\n    );\n  }\n\n  protected override _getCommandLineJsonFilePath(): string {\n    return path.join(\n      AutoinstallerPluginLoader.getPluginAutoinstallerStorePath(this.autoinstaller),\n      this.packageName,\n      this.pluginName,\n      RushConstants.commandLineFilename\n    );\n  }\n}\n"]}