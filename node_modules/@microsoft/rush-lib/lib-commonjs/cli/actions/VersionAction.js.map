{"version":3,"file":"VersionAction.js","sourceRoot":"","sources":["../../../src/cli/actions/VersionAction.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\n// See LICENSE in the project root for license information.\n\nimport * as semver from 'semver';\nimport { type IPackageJson, FileConstants, Enum } from '@rushstack/node-core-library';\nimport type { CommandLineFlagParameter, CommandLineStringParameter } from '@rushstack/ts-command-line';\n\nimport { BumpType, type LockStepVersionPolicy } from '../../api/VersionPolicy';\nimport type { VersionPolicyConfiguration } from '../../api/VersionPolicyConfiguration';\nimport { RushConfiguration } from '../../api/RushConfiguration';\nimport { VersionMismatchFinder } from '../../logic/versionMismatch/VersionMismatchFinder';\nimport type { RushCommandLineParser } from '../RushCommandLineParser';\nimport * as PolicyValidator from '../../logic/policy/PolicyValidator';\nimport { BaseRushAction } from './BaseRushAction';\nimport { PublishGit } from '../../logic/PublishGit';\nimport { Git } from '../../logic/Git';\nimport { RushConstants } from '../../logic/RushConstants';\n\nimport type * as VersionManagerType from '../../logic/VersionManager';\n\nexport const DEFAULT_PACKAGE_UPDATE_MESSAGE: string = 'Bump versions [skip ci]';\nexport const DEFAULT_CHANGELOG_UPDATE_MESSAGE: string = 'Update changelogs [skip ci]';\n\nexport class VersionAction extends BaseRushAction {\n  private readonly _ensureVersionPolicy: CommandLineFlagParameter;\n  private readonly _overrideVersion: CommandLineStringParameter;\n  private readonly _bumpVersion: CommandLineFlagParameter;\n  private readonly _versionPolicy: CommandLineStringParameter;\n  private readonly _bypassPolicy: CommandLineFlagParameter;\n  private readonly _targetBranch: CommandLineStringParameter;\n  private readonly _overwriteBump: CommandLineStringParameter;\n  private readonly _prereleaseIdentifier: CommandLineStringParameter;\n  private readonly _ignoreGitHooksParameter: CommandLineFlagParameter;\n\n  public constructor(parser: RushCommandLineParser) {\n    super({\n      actionName: 'version',\n      summary: 'Manage package versions in the repo.',\n      documentation: 'use this \"rush version\" command to ensure version policies and bump versions.',\n      parser\n    });\n\n    this._targetBranch = this.defineStringParameter({\n      parameterLongName: '--target-branch',\n      parameterShortName: '-b',\n      argumentName: 'BRANCH',\n      description: 'If this flag is specified, changes will be committed and merged into the target branch.'\n    });\n    this._ensureVersionPolicy = this.defineFlagParameter({\n      parameterLongName: '--ensure-version-policy',\n      description: 'Updates package versions if needed to satisfy version policies.'\n    });\n    this._overrideVersion = this.defineStringParameter({\n      parameterLongName: '--override-version',\n      argumentName: 'NEW_VERSION',\n      description:\n        'Override the version in the specified --version-policy. ' +\n        'This setting only works for lock-step version policy and when --ensure-version-policy is specified.'\n    });\n    this._bumpVersion = this.defineFlagParameter({\n      parameterLongName: '--bump',\n      description: 'Bumps package version based on version policies.'\n    });\n    this._bypassPolicy = this.defineFlagParameter({\n      parameterLongName: RushConstants.bypassPolicyFlagLongName,\n      description: 'Overrides \"gitPolicy\" enforcement (use honorably!)'\n    });\n    this._versionPolicy = this.defineStringParameter({\n      parameterLongName: '--version-policy',\n      argumentName: 'POLICY',\n      description: 'The name of the version policy'\n    });\n    this._overwriteBump = this.defineStringParameter({\n      parameterLongName: '--override-bump',\n      argumentName: 'BUMPTYPE',\n      description:\n        'Overrides the bump type in the version-policy.json for the specified version policy. ' +\n        'Valid BUMPTYPE values include: prerelease, patch, preminor, minor, major. ' +\n        'This setting only works for lock-step version policy in bump action.'\n    });\n    this._prereleaseIdentifier = this.defineStringParameter({\n      parameterLongName: '--override-prerelease-id',\n      argumentName: 'ID',\n      description:\n        'Overrides the prerelease identifier in the version value of version-policy.json ' +\n        'for the specified version policy. ' +\n        'This setting only works for lock-step version policy. ' +\n        'This setting increases to new prerelease id when \"--bump\" is provided but only replaces the ' +\n        'prerelease name when \"--ensure-version-policy\" is provided.'\n    });\n    this._ignoreGitHooksParameter = this.defineFlagParameter({\n      parameterLongName: '--ignore-git-hooks',\n      description: `Skips execution of all git hooks. Make sure you know what you are skipping.`\n    });\n  }\n\n  protected async runAsync(): Promise<void> {\n    const currentlyInstalledVariant: string | undefined =\n      await this.rushConfiguration.getCurrentlyInstalledVariantAsync();\n    for (const subspace of this.rushConfiguration.subspaces) {\n      await PolicyValidator.validatePolicyAsync(this.rushConfiguration, subspace, currentlyInstalledVariant, {\n        bypassPolicyAllowed: true,\n        bypassPolicy: this._bypassPolicy.value\n      });\n    }\n    const git: Git = new Git(this.rushConfiguration);\n    const userEmail: string = await git.getGitEmailAsync();\n\n    this._validateInput();\n    const versionManagerModule: typeof VersionManagerType = await import(\n      /* webpackChunkName: 'VersionManager' */\n      '../../logic/VersionManager'\n    );\n    const versionManager: VersionManagerType.VersionManager = new versionManagerModule.VersionManager(\n      this.rushConfiguration,\n      userEmail,\n      this.rushConfiguration.versionPolicyConfiguration\n    );\n\n    if (this._ensureVersionPolicy.value) {\n      this._overwritePolicyVersionIfNeeded();\n      const tempBranch: string = 'version/ensure-' + new Date().getTime();\n      versionManager.ensure(\n        this._versionPolicy.value,\n        true,\n        !!this._overrideVersion.value || !!this._prereleaseIdentifier.value\n      );\n\n      const updatedPackages: Map<string, IPackageJson> = versionManager.updatedProjects;\n      if (updatedPackages.size > 0) {\n        // eslint-disable-next-line no-console\n        console.log(`${updatedPackages.size} packages are getting updated.`);\n        await this._gitProcessAsync(tempBranch, this._targetBranch.value, currentlyInstalledVariant);\n      }\n    } else if (this._bumpVersion.value) {\n      const tempBranch: string = 'version/bump-' + new Date().getTime();\n      await versionManager.bumpAsync(\n        this._versionPolicy.value,\n        this._overwriteBump.value ? Enum.getValueByKey(BumpType, this._overwriteBump.value) : undefined,\n        this._prereleaseIdentifier.value,\n        true\n      );\n      await this._gitProcessAsync(tempBranch, this._targetBranch.value, currentlyInstalledVariant);\n    }\n  }\n\n  private _overwritePolicyVersionIfNeeded(): void {\n    if (!this._overrideVersion.value && !this._prereleaseIdentifier.value) {\n      // No need to overwrite policy version\n      return;\n    }\n    if (this._overrideVersion.value && this._prereleaseIdentifier.value) {\n      throw new Error(\n        `The parameters \"--override-version\" and \"--override-prerelease-id\" cannot be used together.`\n      );\n    }\n\n    if (this._versionPolicy.value) {\n      const versionConfig: VersionPolicyConfiguration = this.rushConfiguration.versionPolicyConfiguration;\n      const policy: LockStepVersionPolicy = versionConfig.getVersionPolicy(\n        this._versionPolicy.value\n      ) as LockStepVersionPolicy;\n      if (!policy || !policy.isLockstepped) {\n        throw new Error(`The lockstep version policy \"${policy.policyName}\" is not found.`);\n      }\n      let newVersion: string | undefined = undefined;\n      if (this._overrideVersion.value) {\n        newVersion = this._overrideVersion.value;\n      } else if (this._prereleaseIdentifier.value) {\n        const newPolicyVersion: semver.SemVer = new semver.SemVer(policy.version);\n        if (newPolicyVersion.prerelease.length) {\n          // Update 1.5.0-alpha.10 to 1.5.0-beta.10\n          // For example, if we are parsing \"1.5.0-alpha.10\" then the newPolicyVersion.prerelease array\n          // would contain [ \"alpha\", 10 ], so we would replace \"alpha\" with \"beta\"\n          newPolicyVersion.prerelease = [\n            this._prereleaseIdentifier.value,\n            ...newPolicyVersion.prerelease.slice(1)\n          ];\n        } else {\n          // Update 1.5.0 to 1.5.0-beta\n          // Since there is no length, we can just set to a new array\n          newPolicyVersion.prerelease = [this._prereleaseIdentifier.value];\n        }\n        newVersion = newPolicyVersion.format();\n      }\n\n      if (newVersion) {\n        versionConfig.update(this._versionPolicy.value, newVersion, true);\n      }\n    } else {\n      throw new Error(\n        'Missing --version-policy parameter to specify which version policy should be overwritten.'\n      );\n    }\n  }\n\n  private _validateInput(): void {\n    if (this._bumpVersion.value && this._ensureVersionPolicy.value) {\n      throw new Error('Please choose --bump or --ensure-version-policy but not together.');\n    }\n\n    if (this._overwriteBump.value && !Enum.tryGetValueByKey(BumpType, this._overwriteBump.value)) {\n      throw new Error(\n        'The value of override-bump is not valid.  ' +\n          'Valid values include prerelease, patch, preminor, minor, and major'\n      );\n    }\n  }\n\n  private _validateResult(variant: string | undefined): void {\n    // Load the config from file to avoid using inconsistent in-memory data.\n    const rushConfig: RushConfiguration = RushConfiguration.loadFromConfigurationFile(\n      this.rushConfiguration.rushJsonFile\n    );\n\n    // Validate result of all subspaces\n    for (const subspace of rushConfig.subspaces) {\n      // Respect the `ensureConsistentVersions` field in rush.json\n      if (!subspace.shouldEnsureConsistentVersions(variant)) {\n        continue;\n      }\n\n      const mismatchFinder: VersionMismatchFinder = VersionMismatchFinder.getMismatches(rushConfig, {\n        subspace,\n        variant\n      });\n      if (mismatchFinder.numberOfMismatches) {\n        throw new Error(\n          'Unable to finish version bump because inconsistencies were encountered. ' +\n            'Run \"rush check\" to find more details.'\n        );\n      }\n    }\n  }\n\n  private async _gitProcessAsync(\n    tempBranch: string,\n    targetBranch: string | undefined,\n    variant: string | undefined\n  ): Promise<void> {\n    // Validate the result before commit.\n    this._validateResult(variant);\n\n    const git: Git = new Git(this.rushConfiguration);\n    const publishGit: PublishGit = new PublishGit(git, targetBranch);\n\n    // Make changes in temp branch.\n    await publishGit.checkoutAsync(tempBranch, true);\n\n    const uncommittedChanges: ReadonlyArray<string> = await git.getUncommittedChangesAsync();\n\n    // Stage, commit, and push the changes to remote temp branch.\n    // Need to commit the change log updates in its own commit\n    const changeLogUpdated: boolean = uncommittedChanges.some((changePath) => {\n      return changePath.indexOf('CHANGELOG.json') > 0;\n    });\n\n    if (changeLogUpdated) {\n      await publishGit.addChangesAsync('.', this.rushConfiguration.changesFolder);\n      await publishGit.addChangesAsync(':/**/CHANGELOG.json');\n      await publishGit.addChangesAsync(':/**/CHANGELOG.md');\n      await publishGit.commitAsync(\n        this.rushConfiguration.gitChangeLogUpdateCommitMessage || DEFAULT_CHANGELOG_UPDATE_MESSAGE,\n        !this._ignoreGitHooksParameter.value\n      );\n    }\n\n    // Commit the package.json and change files updates.\n    const packageJsonUpdated: boolean = uncommittedChanges.some((changePath) => {\n      return changePath.indexOf(FileConstants.PackageJson) > 0;\n    });\n\n    if (packageJsonUpdated) {\n      await publishGit.addChangesAsync(this.rushConfiguration.versionPolicyConfigurationFilePath);\n      await publishGit.addChangesAsync(':/**/package.json');\n      await publishGit.commitAsync(\n        this.rushConfiguration.gitVersionBumpCommitMessage || DEFAULT_PACKAGE_UPDATE_MESSAGE,\n        !this._ignoreGitHooksParameter.value\n      );\n    }\n\n    if (changeLogUpdated || packageJsonUpdated) {\n      await publishGit.pushAsync(tempBranch, !this._ignoreGitHooksParameter.value);\n\n      // Now merge to target branch.\n      await publishGit.fetchAsync();\n      await publishGit.checkoutAsync(targetBranch);\n      await publishGit.pullAsync(!this._ignoreGitHooksParameter.value);\n      await publishGit.mergeAsync(tempBranch, !this._ignoreGitHooksParameter.value);\n      await publishGit.pushAsync(targetBranch, !this._ignoreGitHooksParameter.value);\n      await publishGit.deleteBranchAsync(tempBranch, true, !this._ignoreGitHooksParameter.value);\n    } else {\n      // skip commits\n      await publishGit.fetchAsync();\n      await publishGit.checkoutAsync(targetBranch);\n      await publishGit.deleteBranchAsync(tempBranch, false, !this._ignoreGitHooksParameter.value);\n    }\n  }\n}\n"]}