{"version":3,"file":"install-run-rush.js","sourceRoot":"","sources":["../../src/scripts/install-run-rush.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\n// See LICENSE in the project root for license information.\n\n/* eslint-disable no-console */\n\nimport * as path from 'path';\nimport * as fs from 'fs';\n\nconst {\n  installAndRun,\n  findRushJsonFolder,\n  RUSH_JSON_FILENAME,\n  runWithErrorAndStatusCode\n}: typeof import('./install-run') = __non_webpack_require__('./install-run');\nimport type { ILogger } from '../utilities/npmrcUtilities';\n\nconst PACKAGE_NAME: string = '@microsoft/rush';\nconst RUSH_PREVIEW_VERSION: string = 'RUSH_PREVIEW_VERSION';\nconst INSTALL_RUN_RUSH_LOCKFILE_PATH_VARIABLE: 'INSTALL_RUN_RUSH_LOCKFILE_PATH' =\n  'INSTALL_RUN_RUSH_LOCKFILE_PATH';\n\nfunction _getRushVersion(logger: ILogger): string {\n  const rushPreviewVersion: string | undefined = process.env[RUSH_PREVIEW_VERSION];\n  if (rushPreviewVersion !== undefined) {\n    logger.info(`Using Rush version from environment variable ${RUSH_PREVIEW_VERSION}=${rushPreviewVersion}`);\n    return rushPreviewVersion;\n  }\n\n  const rushJsonFolder: string = findRushJsonFolder();\n  const rushJsonPath: string = path.join(rushJsonFolder, RUSH_JSON_FILENAME);\n  try {\n    const rushJsonContents: string = fs.readFileSync(rushJsonPath, 'utf-8');\n    // Use a regular expression to parse out the rushVersion value because rush.json supports comments,\n    // but JSON.parse does not and we don't want to pull in more dependencies than we need to in this script.\n    const rushJsonMatches: string[] = rushJsonContents.match(\n      /\\\"rushVersion\\\"\\s*\\:\\s*\\\"([0-9a-zA-Z.+\\-]+)\\\"/\n    )!;\n    return rushJsonMatches[1];\n  } catch (e) {\n    throw new Error(\n      `Unable to determine the required version of Rush from ${RUSH_JSON_FILENAME} (${rushJsonFolder}). ` +\n        `The 'rushVersion' field is either not assigned in ${RUSH_JSON_FILENAME} or was specified ` +\n        'using an unexpected syntax.'\n    );\n  }\n}\n\nfunction _getBin(scriptName: string): string {\n  switch (scriptName.toLowerCase()) {\n    case 'install-run-rush-pnpm.js':\n      return 'rush-pnpm';\n    case 'install-run-rushx.js':\n      return 'rushx';\n    default:\n      return 'rush';\n  }\n}\n\nfunction _run(): void {\n  const [\n    nodePath /* Ex: /bin/node */,\n    scriptPath /* /repo/common/scripts/install-run-rush.js */,\n    ...packageBinArgs /* [build, --to, myproject] */\n  ]: string[] = process.argv;\n\n  // Detect if this script was directly invoked, or if the install-run-rushx script was invokved to select the\n  // appropriate binary inside the rush package to run\n  const scriptName: string = path.basename(scriptPath);\n  const bin: string = _getBin(scriptName);\n  if (!nodePath || !scriptPath) {\n    throw new Error('Unexpected exception: could not detect node path or script path');\n  }\n\n  let commandFound: boolean = false;\n  let logger: ILogger = { info: console.log, error: console.error };\n\n  for (const arg of packageBinArgs) {\n    if (arg === '-q' || arg === '--quiet') {\n      // The -q/--quiet flag is supported by both `rush` and `rushx`, and will suppress\n      // any normal informational/diagnostic information printed during startup.\n      //\n      // To maintain the same user experience, the install-run* scripts pass along this\n      // flag but also use it to suppress any diagnostic information normally printed\n      // to stdout.\n      logger = {\n        info: () => {},\n        error: console.error\n      };\n    } else if (!arg.startsWith('-') || arg === '-h' || arg === '--help') {\n      // We either found something that looks like a command (i.e. - doesn't start with a \"-\"),\n      // or we found the -h/--help flag, which can be run without a command\n      commandFound = true;\n    }\n  }\n\n  if (!commandFound) {\n    console.log(`Usage: ${scriptName} <command> [args...]`);\n    if (scriptName === 'install-run-rush-pnpm.js') {\n      console.log(`Example: ${scriptName} pnpm-command`);\n    } else if (scriptName === 'install-run-rush.js') {\n      console.log(`Example: ${scriptName} build --to myproject`);\n    } else {\n      console.log(`Example: ${scriptName} custom-command`);\n    }\n    process.exit(1);\n  }\n\n  runWithErrorAndStatusCode(logger, () => {\n    const version: string = _getRushVersion(logger);\n    logger.info(`The ${RUSH_JSON_FILENAME} configuration requests Rush version ${version}`);\n\n    const lockFilePath: string | undefined = process.env[INSTALL_RUN_RUSH_LOCKFILE_PATH_VARIABLE];\n    if (lockFilePath) {\n      logger.info(\n        `Found ${INSTALL_RUN_RUSH_LOCKFILE_PATH_VARIABLE}=\"${lockFilePath}\", installing with lockfile.`\n      );\n    }\n\n    return installAndRun(logger, PACKAGE_NAME, version, bin, packageBinArgs, lockFilePath);\n  });\n}\n\n_run();\n"]}