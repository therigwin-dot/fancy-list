{"version":3,"file":"TempProjectHelper.js","sourceRoot":"","sources":["../../src/logic/TempProjectHelper.ts"],"names":[],"mappings":";AAAA,4FAA4F;AAC5F,2DAA2D;;;;;;;;;;;;;;;;;;;;;;;;;;AAE3D,oEAAwF;AACxF,yCAA2B;AAC3B,2CAA6B;AAI7B,mDAAgD;AAGhD,qEAAqE;AACrE,+BAA+B;AAE/B,MAAa,iBAAiB;IAI5B,YAAmB,iBAAoC,EAAE,QAAkB;QACzE,IAAI,CAAC,kBAAkB,GAAG,iBAAiB,CAAC;QAC5C,IAAI,CAAC,SAAS,GAAG,QAAQ,CAAC;IAC5B,CAAC;IAED;;OAEG;IACI,wBAAwB,CAAC,WAAqC;QACnE,8BAAU,CAAC,YAAY,CAAC,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,SAAS,CAAC,yBAAyB,EAAE,EAAE,UAAU,CAAC,CAAC,CAAC;QAC9F,MAAM,WAAW,GAAW,IAAI,CAAC,kBAAkB,CAAC,WAAW,CAAC,CAAC;QACjE,MAAM,iBAAiB,GAAW,IAAI,CAAC,oBAAoB,CAAC,WAAW,CAAC,CAAC;QAEzE,8BAAU,CAAC,UAAU,CAAC,WAAW,CAAC,CAAC;QAEnC,2EAA2E;QAC3E,MAAM,gBAAgB,GAAW,SAAS,CAAC;QAE3C,MAAM,UAAU,GAAsB;YACpC,IAAI,EAAE,IAAI;YACV,IAAI,EAAE,WAAW;YACjB,GAAG,EAAE,iBAAiB;YACtB,QAAQ,EAAE,IAAI;YACd,OAAO,EAAE,IAAI;YACb,KAAK,EAAE,IAAI;YACX,IAAI,EAAE,IAAI;YACV,MAAM,EAAE,gBAAgB;YACxB,MAAM,EAAE,CAAC,OAAe,EAAE,IAAkB,EAAW,EAAE;gBACvD,IACE,CAAC,IAAI,CAAC,kBAAkB,CAAC,wBAAwB,CAAC,aAAa,CAAC,oCAAoC,EACpG,CAAC;oBACD,IAAI,CAAC,IAAI;wBACP,CAAC,IAAI,CAAC,IAAI,GAAG,CAAC,KAAK,CAAC,GAAG,iCAAa,CAAC,OAAO,GAAG,iCAAa,CAAC,SAAS,GAAG,iCAAa,CAAC,UAAU,CAAC;gBACtG,CAAC;gBACD,OAAO,IAAI,CAAC;YACd,CAAC;SACmB,CAAC;QACvB,yBAAyB;QACzB,GAAG,CAAC,MAAM,CAAC,UAAU,EAAE,CAAC,iCAAa,CAAC,WAAW,CAAC,CAAC,CAAC;IACtD,CAAC;IAED;;;OAGG;IACI,kBAAkB,CAAC,OAAiC;QACzD,OAAO,IAAI,CAAC,IAAI,CACd,IAAI,CAAC,SAAS,CAAC,yBAAyB,EAAE,EAC1C,6BAAa,CAAC,0BAA0B,EACxC,GAAG,OAAO,CAAC,uBAAuB,MAAM,CACzC,CAAC;IACJ,CAAC;IAEM,oBAAoB,CAAC,WAAqC;QAC/D,MAAM,uBAAuB,GAAW,WAAW,CAAC,uBAAuB,CAAC;QAC5E,OAAO,IAAI,CAAC,IAAI,CACd,IAAI,CAAC,SAAS,CAAC,yBAAyB,EAAE,EAC1C,6BAAa,CAAC,0BAA0B,EACxC,uBAAuB,CACxB,CAAC;IACJ,CAAC;CACF;AAjED,8CAiEC","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\n// See LICENSE in the project root for license information.\n\nimport { FileConstants, FileSystem, PosixModeBits } from '@rushstack/node-core-library';\nimport * as tar from 'tar';\nimport * as path from 'path';\n\nimport type { RushConfigurationProject } from '../api/RushConfigurationProject';\nimport type { RushConfiguration } from '../api/RushConfiguration';\nimport { RushConstants } from './RushConstants';\nimport type { Subspace } from '../api/Subspace';\n\n// The PosixModeBits are intended to be used with bitwise operations.\n/* eslint-disable no-bitwise */\n\nexport class TempProjectHelper {\n  private _rushConfiguration: RushConfiguration;\n  private _subspace: Subspace;\n\n  public constructor(rushConfiguration: RushConfiguration, subspace: Subspace) {\n    this._rushConfiguration = rushConfiguration;\n    this._subspace = subspace;\n  }\n\n  /**\n   * Deletes the existing tarball and creates a tarball for the given rush project\n   */\n  public createTempProjectTarball(rushProject: RushConfigurationProject): void {\n    FileSystem.ensureFolder(path.resolve(this._subspace.getSubspaceTempFolderPath(), 'projects'));\n    const tarballFile: string = this.getTarballFilePath(rushProject);\n    const tempProjectFolder: string = this.getTempProjectFolder(rushProject);\n\n    FileSystem.deleteFile(tarballFile);\n\n    // NPM expects the root of the tarball to have a directory called 'package'\n    const npmPackageFolder: string = 'package';\n\n    const tarOptions: tar.CreateOptions = {\n      gzip: true,\n      file: tarballFile,\n      cwd: tempProjectFolder,\n      portable: true,\n      noMtime: true,\n      noPax: true,\n      sync: true,\n      prefix: npmPackageFolder,\n      filter: (tarPath: string, stat: tar.FileStat): boolean => {\n        if (\n          !this._rushConfiguration.experimentsConfiguration.configuration.noChmodFieldInTarHeaderNormalization\n        ) {\n          stat.mode =\n            (stat.mode & ~0x1ff) | PosixModeBits.AllRead | PosixModeBits.UserWrite | PosixModeBits.AllExecute;\n        }\n        return true;\n      }\n    } as tar.CreateOptions;\n    // create the new tarball\n    tar.create(tarOptions, [FileConstants.PackageJson]);\n  }\n\n  /**\n   * Gets the path to the tarball\n   * Example: \"C:\\MyRepo\\common\\temp\\projects\\my-project-2.tgz\"\n   */\n  public getTarballFilePath(project: RushConfigurationProject): string {\n    return path.join(\n      this._subspace.getSubspaceTempFolderPath(),\n      RushConstants.rushTempProjectsFolderName,\n      `${project.unscopedTempProjectName}.tgz`\n    );\n  }\n\n  public getTempProjectFolder(rushProject: RushConfigurationProject): string {\n    const unscopedTempProjectName: string = rushProject.unscopedTempProjectName;\n    return path.join(\n      this._subspace.getSubspaceTempFolderPath(),\n      RushConstants.rushTempProjectsFolderName,\n      unscopedTempProjectName\n    );\n  }\n}\n"]}