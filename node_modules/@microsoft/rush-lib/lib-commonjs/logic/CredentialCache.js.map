{"version":3,"file":"CredentialCache.js","sourceRoot":"","sources":["../../src/logic/CredentialCache.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\n// See LICENSE in the project root for license information.\n\nimport { FileSystem, JsonFile, JsonSchema, LockFile } from '@rushstack/node-core-library';\n\nimport { Utilities } from '../utilities/Utilities';\nimport { RushUserConfiguration } from '../api/RushUserConfiguration';\nimport schemaJson from '../schemas/credentials.schema.json';\nimport { objectsAreDeepEqual } from '../utilities/objectUtilities';\n\nconst CACHE_FILENAME: string = 'credentials.json';\nconst LATEST_CREDENTIALS_JSON_VERSION: string = '0.1.0';\n\ninterface ICredentialCacheJson {\n  version: string;\n  cacheEntries: {\n    [credentialCacheId: string]: ICacheEntryJson;\n  };\n}\n\ninterface ICacheEntryJson {\n  expires: number;\n  credential: string;\n  credentialMetadata?: object;\n}\n\n/**\n * @beta\n */\nexport interface ICredentialCacheEntry {\n  expires?: Date;\n  credential: string;\n  credentialMetadata?: object;\n}\n\n/**\n * @beta\n */\nexport interface ICredentialCacheOptions {\n  supportEditing: boolean;\n}\n\n/**\n * @beta\n */\nexport class CredentialCache /* implements IDisposable */ {\n  private readonly _cacheFilePath: string;\n  private readonly _cacheEntries: Map<string, ICacheEntryJson>;\n  private _modified: boolean = false;\n  private _disposed: boolean = false;\n  private _supportsEditing: boolean;\n  private readonly _lockfile: LockFile | undefined;\n\n  private constructor(\n    cacheFilePath: string,\n    loadedJson: ICredentialCacheJson | undefined,\n    lockfile: LockFile | undefined\n  ) {\n    if (loadedJson && loadedJson.version !== LATEST_CREDENTIALS_JSON_VERSION) {\n      throw new Error(`Unexpected credentials.json file version: ${loadedJson.version}`);\n    }\n\n    this._cacheFilePath = cacheFilePath;\n    this._cacheEntries = new Map<string, ICacheEntryJson>(Object.entries(loadedJson?.cacheEntries || {}));\n    this._supportsEditing = !!lockfile;\n    this._lockfile = lockfile;\n  }\n\n  public static async initializeAsync(options: ICredentialCacheOptions): Promise<CredentialCache> {\n    const rushUserFolderPath: string = RushUserConfiguration.getRushUserFolderPath();\n    const cacheFilePath: string = `${rushUserFolderPath}/${CACHE_FILENAME}`;\n    const jsonSchema: JsonSchema = JsonSchema.fromLoadedObject(schemaJson);\n\n    let loadedJson: ICredentialCacheJson | undefined;\n    try {\n      loadedJson = await JsonFile.loadAndValidateAsync(cacheFilePath, jsonSchema);\n    } catch (e) {\n      if (!FileSystem.isErrnoException(e as Error)) {\n        throw e;\n      }\n    }\n\n    let lockfile: LockFile | undefined;\n    if (options.supportEditing) {\n      lockfile = await LockFile.acquireAsync(rushUserFolderPath, `${CACHE_FILENAME}.lock`);\n    }\n\n    const credentialCache: CredentialCache = new CredentialCache(cacheFilePath, loadedJson, lockfile);\n    return credentialCache;\n  }\n\n  public static async usingAsync(\n    options: ICredentialCacheOptions,\n    doActionAsync: (credentialCache: CredentialCache) => Promise<void> | void\n  ): Promise<void> {\n    await Utilities.usingAsync(async () => await CredentialCache.initializeAsync(options), doActionAsync);\n  }\n\n  public setCacheEntry(cacheId: string, entry: ICredentialCacheEntry): void {\n    this._validate(true);\n\n    const { expires, credential, credentialMetadata } = entry;\n    const expiresMilliseconds: number = expires?.getTime() || 0;\n    const existingCacheEntry: ICacheEntryJson | undefined = this._cacheEntries.get(cacheId);\n    if (\n      existingCacheEntry?.credential !== credential ||\n      existingCacheEntry?.expires !== expiresMilliseconds ||\n      !objectsAreDeepEqual(existingCacheEntry?.credentialMetadata, credentialMetadata)\n    ) {\n      this._modified = true;\n      this._cacheEntries.set(cacheId, {\n        expires: expiresMilliseconds,\n        credential,\n        credentialMetadata\n      });\n    }\n  }\n\n  public tryGetCacheEntry(cacheId: string): ICredentialCacheEntry | undefined {\n    this._validate(false);\n\n    const cacheEntry: ICacheEntryJson | undefined = this._cacheEntries.get(cacheId);\n    if (cacheEntry) {\n      const result: ICredentialCacheEntry = {\n        expires: cacheEntry.expires ? new Date(cacheEntry.expires) : undefined,\n        credential: cacheEntry.credential,\n        credentialMetadata: cacheEntry.credentialMetadata\n      };\n\n      return result;\n    } else {\n      return undefined;\n    }\n  }\n\n  public deleteCacheEntry(cacheId: string): void {\n    this._validate(true);\n\n    if (this._cacheEntries.has(cacheId)) {\n      this._modified = true;\n      this._cacheEntries.delete(cacheId);\n    }\n  }\n\n  public trimExpiredEntries(): void {\n    this._validate(true);\n\n    const now: number = Date.now();\n    for (const [cacheId, cacheEntry] of this._cacheEntries.entries()) {\n      if (cacheEntry.expires < now) {\n        this._cacheEntries.delete(cacheId);\n        this._modified = true;\n      }\n    }\n  }\n\n  public async saveIfModifiedAsync(): Promise<void> {\n    this._validate(true);\n\n    if (this._modified) {\n      const cacheEntriesJson: { [cacheId: string]: ICacheEntryJson } = {};\n      for (const [cacheId, cacheEntry] of this._cacheEntries.entries()) {\n        cacheEntriesJson[cacheId] = cacheEntry;\n      }\n\n      const newJson: ICredentialCacheJson = {\n        version: LATEST_CREDENTIALS_JSON_VERSION,\n        cacheEntries: cacheEntriesJson\n      };\n      await JsonFile.saveAsync(newJson, this._cacheFilePath, {\n        ensureFolderExists: true,\n        updateExistingFile: true,\n        ignoreUndefinedValues: true\n      });\n\n      this._modified = false;\n    }\n  }\n\n  public dispose(): void {\n    this._lockfile?.release();\n    this._disposed = true;\n  }\n\n  private _validate(requiresEditing: boolean): void {\n    if (!this._supportsEditing && requiresEditing) {\n      throw new Error(`This instance of ${CredentialCache.name} does not support editing.`);\n    }\n\n    if (this._disposed) {\n      throw new Error(`This instance of ${CredentialCache.name} has been disposed.`);\n    }\n  }\n}\n"]}