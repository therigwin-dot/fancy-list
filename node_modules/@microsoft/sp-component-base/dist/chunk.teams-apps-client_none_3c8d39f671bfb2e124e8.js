"use strict";(self["webpackJsonp_467dc675-7cc5-4709-8aac-78e3b71bd2f6_1.21.1"]=self["webpackJsonp_467dc675-7cc5-4709-8aac-78e3b71bd2f6_1.21.1"]||[]).push([[216],{165:(e,t,n)=>{n.r(t),n.d(t,{TeamsAppsClient:()=>l});var a=n(207),i=n(909),r=n(408),o=n(620),s=n(529),c="/appCatalogs/teamsApps",d="beta",l=function(){function e(e){this._appComponentsPermissionsPromises=new Map,this._serviceScope=e}return e.prototype.getTeamsAppComponentManifests=function(){var t=this;if(!e._getTeamsAppComponentManifestsPromise)if((0,o.T)()){var n=new a._QosMonitor("TeamsAppsClient.FetchTeamsApp");e._getTeamsAppComponentManifestsPromise=this._msGraphClient.then(function(e){return e.api("".concat(c,"?").concat("$expand=appDefinitions($expand=outlineIcon,colorIcon,dashboardCards)&$filter=appDefinitions/any(a:a/dashboardCards/$count ne 0)")).version(d).get()}).then(function(e){var a=e.value.map(function(e){return t._teamsAppCatalogItemToAceManifests(e)});return Promise.all(a).then(function(e){var t=[];return e.forEach(function(e){t.push.apply(t,e)}),n.writeSuccess(),t})}).catch(function(t){return n.writeUnexpectedFailure(void 0,t),e._getTeamsAppComponentManifestsPromise=void 0,[]})}else e._getTeamsAppComponentManifestsPromise=Promise.resolve([]);return e._getTeamsAppComponentManifestsPromise},e.prototype.syncComponent=function(t){var n,s=this,c=t;if(!(0,o.T)()||!c.isPendingTeamsAppSync)return Promise.resolve(t);var d=new a._QosMonitor("TeamsAppsClient.SyncComponent");if(!(null===(n=t.properties)||void 0===n?void 0:n.teamsAppComponent))return d.writeExpectedFailure("TeamsAppComponentMissing"),new Promise(function(){throw new Error("Teams App component manifest is missing teamsAppComponent property")});var l=this._serviceScope.consume(i.SPHttpClient.serviceKey),u=this._serviceScope.consume(r.PageContext.serviceKey).web.absoluteUrl,f=void 0,p=e._ensureAppCatalogPromise;if(!e._ensureAppCatalogPromise){var m="".concat(u,"/_api/web/EnsureTenantAppCatalog(callerId='TeamsAppsClient')");p=e._ensureAppCatalogPromise=l.post(m,i.SPHttpClient.configurations.v1,{}).then(function(e){return e.json()}).then(function(e){if(e.error)throw new Error(e.error.message)}).catch(function(t){throw f="EnsureAppCatalogFailed",e._ensureAppCatalogPromise=void 0,t})}return p.then(function(){var e="".concat(u,"/_api/web/SyncTeamsComponent"),n=t.properties.teamsAppComponent;return l.post(e,i.SPHttpClient.configurations.v1,{body:JSON.stringify({teamsComponent:n})}).catch(function(e){throw f="SyncComponentFailed",e})}).then(function(e){return e.json()}).then(function(e){if(e.error)throw f="SyncComponentFailed",new Error(e.error.message);var n=e,a=JSON.parse(n.Manifest);n.ManifestActivatedTime&&(a.manifestActivatedTime=n.ManifestActivatedTime),d.writeSuccess();var i=t.properties.teamsAppComponent.appId;return s._appComponentsPermissionsPromises.set(i,Promise.resolve(new Set([i]))),a}).catch(function(e){throw d.writeUnexpectedFailure(f,e),e})},e.prototype.requestPermissions=function(e){return(0,o.T)()&&e.length?this._requestAppsPermissions(e).then(function(){}):Promise.resolve()},e.prototype.isComponentEnabled=function(e){return(0,o.T)()?this._appComponentsPermissionsPromises.has(e)?this._appComponentsPermissionsPromises.get(e).then(function(t){return t.has(e)||!1}):this._requestAppsPermissions([{appId:e,componentId:""}]).then(function(t){return t.has(e)||!1}):Promise.resolve(!0)},e.prototype._requestAppsPermissions=function(e){var t,n=this,i=(0,s.uniq)(e.map(function(e){return e.appId})).filter(function(e){return!n._appComponentsPermissionsPromises.has(e)});if(i.length>30&&(t=this._requestAppsPermissionsBatched(i)),!t){var r=new a._QosMonitor("TeamsAppsClient.RequestAppsPermissions");t=this._msGraphClient.then(function(e){return e.api(n._getCheckPermissionsUrl(i)).version(d).get()}).then(function(e){if(e.error)return r.writeUnexpectedFailure("RequestFailed",new Error(e.error.message)),new Set;var t=new Set;return e.value.map(function(e){t.add(e.id)}),r.writeSuccess(),t}).catch(function(e){return r.writeUnexpectedFailure(void 0,e),new Set})}return i.forEach(function(e){n._appComponentsPermissionsPromises.set(e,t)}),t},e.prototype._requestAppsPermissionsBatched=function(e){var t=new a._QosMonitor("TeamsAppsClient.RequestAppsPermissionsBatched"),n=new Set,i=Math.ceil(e.length/300),r=0,o=[];try{for(;r<i;){for(var s={requests:[]},c=300*r,l=Math.min(c+300,e.length),u=c;u<l;){var f=u+30,p=e.slice(u,f);s.requests.push({id:u.toString(),method:"GET",url:this._getCheckPermissionsUrl(p)}),u=f}o.push(s),r++}}catch(e){return t.writeUnexpectedFailure("BatchSplitLogicError",e),Promise.resolve(n)}var m=[];return this._msGraphClient.then(function(e){var t=o.map(function(t){return e.api("$batch").version(d).post(t).then(function(e){e.responses.forEach(function(e){200===e.status?e.body.value.map(function(e){n.add(e.id)}):m.push(new Error(e.body.error.message))})}).catch(function(e){m.push(e)})});return Promise.all(t)}).then(function(){return m.length&&t.writeUnexpectedFailure("SomeBatchRequestsError",void 0,{errors:m}),n}).catch(function(e){return t.writeUnexpectedFailure("BatchRequestError",e),new Set})},e.prototype._getCheckPermissionsUrl=function(e){return"".concat(c,"?").concat("$expand=appDefinitions($expand=dashboardCards)&$filter=appDefinitions/any(a:a/dashboardCards/$count ne 0) and id in ('{appIds}')".replace("{appIds}",e.join("','")))},Object.defineProperty(e.prototype,"_msGraphClient",{get:function(){return this._msGraphClientFactory||(this._msGraphClientFactory=this._serviceScope.consume(i.MSGraphClientFactory.serviceKey)),this._msGraphClientDeferred||(this._msGraphClientDeferred=this._msGraphClientFactory.getClientInternal("3")),this._msGraphClientDeferred},enumerable:!1,configurable:!0}),e.prototype._teamsAppCatalogItemToAceManifests=function(e){var t,n,a=this,i=null===(t=e.appDefinitions[0].colorIcon)||void 0===t?void 0:t.webUrl,r=[],o=e.appDefinitions[0].dashboardCards||[],s=[];o.forEach(function(t){var o,c,d={appId:e.id,externalAppId:e.externalId||void 0,componentId:t.id,groupId:"5c03119e-3074-46fd-976b-c60198311f70",iconUrl:null===(o=t.icon)||void 0===o?void 0:o.iconUrl,officeUIFabricIconName:null===(c=t.icon)||void 0===c?void 0:c.officeUIFabricIconName,description:t.description,name:t.displayName,botId:t.contentSource.botConfiguration.botId,appName:e.displayName,appDescription:e.appDefinitions[0].description,version:e.appDefinitions[0].version,defaultSize:"".concat(t.defaultSize.charAt(0).toUpperCase()).concat(t.defaultSize.slice(1))},l=a._teamsAppComponentToAceManifest(d);s.push(l),d.iconUrl||d.officeUIFabricIconName||(r.push(l),!n&&i&&(n=a._msGraphClient.then(function(e){return e.api(i).responseType("blob").get()})))});var c=Promise.resolve(s);return r.length&&n&&(c=n.then(function(e){return a._convertBlobToBase64(e)}).then(function(e){return r.forEach(function(t){t.preconfiguredEntries[0].iconImageUrl=e,t.properties.teamsAppComponent.iconUrl=e}),s})),c},e.prototype._convertBlobToBase64=function(e){return new Promise(function(t,n){var a=new FileReader;a.onerror=n,a.onload=function(){var e=a.result;e||n(""),t(e.substr(e.indexOf(", ")+1))},a.readAsDataURL(e)})},e.prototype._teamsAppComponentToAceManifest=function(e){return{id:e.componentId,manifestVersion:2,version:e.version,componentType:"AdaptiveCardExtension",alias:e.componentId,properties:{teamsAppComponent:e},loaderConfig:{entryModuleId:e.componentId,internalModuleBaseUrls:["HTTPS://CLIENTSIDEASSETSLIBRARY/"],scriptResources:{}},preconfiguredEntries:[{cardSize:e.defaultSize,title:{default:e.name},description:{default:e.description},iconImageUrl:e.iconUrl,officeFabricIconFontName:e.officeUIFabricIconName,groupId:e.groupId,properties:{}}],connectedTeamsAppId:e.appId,isPendingTeamsAppSync:!0}},e}()}
}]);